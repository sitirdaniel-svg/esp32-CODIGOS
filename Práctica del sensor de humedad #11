#include <ThingerESP32.h>
#include <WiFi.h>
#include <PubSubClient.h>
#include <DHT.h>
#include <Adafruit_Sensor.h>

// ---------- WIFI ----------
const char* ssid = "iPhone de Jose";
const char* password = "matuteP12345";

// ---------- THINGER.IO ----------
#define NOMBRE DE USUARIO "JosePerez"
#define ID_DISPOSITIVO "Humedad_esp"
#define CREDENCIAL_DISPOSITIVO "123456789"
const char* mqtt_server = "backend.thinger.io";

// ---------- DHT ----------
#define DHTPIN 23
#define DHTTYPE DHT11
DHT dht(DHTPIN, DHTTYPE);

// ---------- MQTT ----------
WiFiClient espClient;
PubSubClient cliente(espClient);

// ---------- TEMA ----------
String topic = "v1/usuarios/" NOMBRE DE USUARIO "/dispositivos/" ID_DISPOSITIVO "/data/DHT11";

// ---------- CONECTAR WIFI ----------
void setup_wifi() {
delay(10);
Serial.println("Conectando a WiFi...");
WiFi.begin(ssid, password);

mientras (WiFi.status() != WL_CONNECTED) {
retraso(1000);
Serial.print(".");
}

Serial.println("\nWiFi conectado");
Serie.print("IP: ");
Serial.println(WiFi.localIP());
}

// ---------- CONECTAR MQTT ----------
void reconnect() {
while (!client.connected()) {
Serial.print("Conectando a Thinger.io...");
if (client.connect(DEVICE_ID, USERNAME, DEVICE_CREDENTIAL)) {
Serial.println(" conectado");
} else {
Serial.print(" fallo, rc=");
Serial.print(client.state());
Serial.println(" reintentando...");
delay(3000);
}
}
}

// ---------- CONFIGURACIÓN ----------
void setup() {
Serial.begin(115200);
dht.begin();

setup_wifi();

cliente.setServer(mqtt_server, 1883);
}

// ---------- BUCLE ----------
void loop() {
if (!client.connected()) {
reconnect();
}
cliente.loop();

flotante h = dht.readHumidity();
flotante t = dht.readTemperature();

if (isnan(h) || isnan(t)) {
Serial.println("Error al leer el DHT11");
retraso(2000);
devolver;
}

char payload[100];
sprintf(payload, "{"temperatura":%.1f,"humedad":%.1f}", t, h);

cliente.publicar(tema.c_str(), carga útil);
Serial.print("Enviado: ");
Serial.println(carga útil);

retraso(5000);
}
